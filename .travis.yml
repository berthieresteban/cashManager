---
services: 
  - docker

jobs:
  include:
    - stage: Tests Backend
      if: type = pull_request AND branch = 1-dev
      script:
        - npm install
        - npm run build-backend
        - npm run run-backend
        - npm run test-backend

    - stage: Deploy Back
      if: type = push AND branch = master
      script:
        - docker login -u $DOCKERUSERNAME -p $DOCKERPASSWORD
        - npm run build-backend
        - docker push berthieresteban/cashmanager_api:latest

    - stage: Deploy APK
      if: type = push AND branch = master
      os: linux
      dist: trusty
      language: android
      install: true
      jdk: oraclejdk8
      components:
        - build-tools-27.0.3
        - android-28
      before-install:
        - chmod +x gradlew
        - ./gradlew dependencies || true
      script:
        - ./gradlew build --scan -s
        - docker login -u $DOCKERUSERNAME -p $DOCKERPASSWORD
        - ./gradlew clean build assembleDebug
        - npm run build-client
        - docker push berthieresteban/cashmanager_client:latest